# Тестирование проекта

Этот проект включает комплексную систему тестирования с различными уровнями тестов.

## Типы тестов

### 1. Unit тесты (`server/db.test.ts`)
Тестируют отдельные функции базы данных:
- Создание и получение пользователей
- Управление комнатами
- Управление участниками
- Функции чата

### 2. Интеграционные тесты (`server/api.test.ts`)
Тестируют tRPC API endpoints:
- Аутентификация
- Создание и управление комнатами
- Чат функциональность
- Обработка ошибок

### 3. Компонентные тесты (`client/src/components.test.tsx`)
Тестируют React компоненты:
- Рендеринг компонентов
- Взаимодействие пользователя
- Состояния загрузки и ошибок

### 4. End-to-End тесты (`e2e/scenarios.test.ts`)
Тестируют полные пользовательские сценарии:
- Полный жизненный цикл комнаты
- Множественные участники
- Чат с несколькими пользователями
- Сценарии ошибок

## Настройка тестового окружения

### Требования
- MySQL база данных
- Node.js 18+
- pnpm

### Переменные окружения
Создайте `.env.test` файл:
```env
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=your_password
DATABASE_URL=mysql://root:your_password@localhost:3306/utki_test
```

## Команды для запуска тестов

### Все тесты
```bash
pnpm test
```

### Отдельные типы тестов
```bash
# Unit тесты
pnpm test:unit

# API тесты
pnpm test:api

# Компонентные тесты
pnpm test:components

# E2E тесты
pnpm test:e2e
```

### Режим наблюдения
```bash
pnpm test:watch
```

### Покрытие кода
```bash
pnpm test:coverage
```

### CI/CD режим
```bash
pnpm test:ci
```

## Структура тестов

```
├── server/
│   ├── test-setup.ts          # Настройка тестовой БД
│   ├── db.test.ts            # Unit тесты БД
│   └── api.test.ts           # API интеграционные тесты
├── client/src/
│   ├── test-setup.ts         # Настройки для React тестов
│   └── components.test.tsx  # Компонентные тесты
├── e2e/
│   └── scenarios.test.ts     # E2E тесты
└── vitest.config.ts          # Конфигурация тестов
```

## Тестовая база данных

Тесты используют отдельную тестовую базу данных `utki_test`:
- Автоматически создается перед тестами
- Очищается после каждого теста
- Изолирована от основной базы данных

## Покрытие кода

Тесты покрывают:
- ✅ Функции базы данных
- ✅ API endpoints
- ✅ React компоненты
- ✅ Пользовательские сценарии
- ✅ Обработка ошибок

## Отладка тестов

### Запуск конкретного теста
```bash
pnpm test -- --run server/db.test.ts
```

### Подробный вывод
```bash
pnpm test -- --reporter=verbose
```

### Отладка в IDE
Настройте VS Code для отладки тестов:
```json
{
  "type": "node",
  "request": "launch",
  "name": "Debug Tests",
  "program": "${workspaceFolder}/node_modules/vitest/vitest.mjs",
  "args": ["run", "--reporter=verbose"],
  "console": "integratedTerminal"
}
```

## Лучшие практики

1. **Изоляция тестов**: Каждый тест независим
2. **Очистка данных**: Данные очищаются после каждого теста
3. **Моки**: Внешние зависимости замокированы
4. **Описательные имена**: Тесты имеют понятные названия
5. **Покрытие**: Стремитесь к высокому покрытию кода

## Troubleshooting

### Проблемы с базой данных
- Убедитесь, что MySQL запущен
- Проверьте переменные окружения
- Убедитесь, что у пользователя есть права на создание БД

### Проблемы с зависимостями
```bash
pnpm install
```

### Проблемы с портами
Если порт занят, тесты автоматически найдут свободный порт.

### Проблемы с моками
Убедитесь, что все внешние зависимости замокированы в `test-setup.ts`.





